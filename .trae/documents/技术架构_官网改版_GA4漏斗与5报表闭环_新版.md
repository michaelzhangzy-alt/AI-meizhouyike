## 1.Architecture design
```mermaid
graph TD
  A["用户浏览器"] --> B["React 前端应用"]
  B --> C["GA4 gtag.js"]
  B --> D["API 网关（Supabase Edge Functions）"]
  D --> E["Supabase Auth"]
  D --> F["Supabase Database"]
  D --> G["Google Analytics Data API"]

  subgraph "Frontend Layer"
    B
    C
  end

  subgraph "Backend Layer（Supabase）"
    D
  end

  subgraph "Service Layer (Provided by Supabase)"
    E
    F
  end

  subgraph "External Services"
    G
  end
```

## 2.Technology Description
- Frontend: React@18 + react-router + tailwindcss@3 + vite + GA4 gtag.js
- Backend: Supabase（Auth + Database + Edge Functions + Scheduled Functions）

## 3.Route definitions
| Route | Purpose |
|-------|---------|
| / | 主页：核心卖点、入口与转化 CTA |
| /live | 本周直播课列表：按周展示与报名入口 |
| /course/:id | 课程详情：承接转化与报名 |
| /ai | AI资讯列表：原创/外链导读 |
| /ai/:id | AI资讯详情：原创正文或外链导读+跳转 |
| /login | 运营登录：进入数据看板 |
| /analytics | 数据看板：GA4 漏斗与日常 5 报表（需登录） |

## 4.API definitions
### 4.1 类型定义（前后端通用，TypeScript）
```ts
export type LiveSession = {
  id: string
  title: string
  startAt: string // ISO
  endAt?: string
  status: 'open' | 'ended'
  courseId: string
}

export type Course = {
  id: string
  title: string
  summary: string
  highlights: string[]
  audience: string[]
}

export type AiArticle = {
  id: string
  type: 'original' | 'external'
  title: string
  summary: string
  content?: string // original only
  externalUrl?: string // external only
  externalGuide?: string // external only
  tags: string[]
  publishedAt: string // ISO
}

export type Lead = {
  id: string
  sourcePage: 'home' | 'live' | 'course'
  courseId?: string
  liveSessionId?: string
  name?: string
  phoneOrWechat: string
  intent?: string
  createdAt: string
}

export type FunnelReport = {
  dateRange: { from: string; to: string }
  steps: Array<{ name: string; users: number; rateToNext?: number }>
  breakdown?: { channel: string; steps: Array<{ name: string; users: number }> }[]
}

export type Daily5ReportSnapshot = {
  id: string
  reportDate: string // yyyy-mm-dd
  trafficOverview: unknown
  funnel: unknown
  livePerformance: unknown
  aiContentPerformance: unknown
  leadResult: unknown
  createdAt: string
}

export type DailyOpsNote = {
  id: string
  noteDate: string // yyyy-mm-dd
  conclusion: string
  actionItems: Array<{ owner: string; dueDate: string; item: string }>
  createdAt: string
}
```

### 4.2 Edge Function API（示例）
- 内容
  - `GET /api/public/live-sessions?week=YYYY-WW`
  - `GET /api/public/course/:id`
  - `GET /api/public/ai?type=original|external&tag=`
  - `GET /api/public/ai/:id`
- 线索
  - `POST /api/public/leads`（提交报名/咨询表单）
- 数据看板（需登录）
  - `GET /api/analytics/funnel?from=YYYY-MM-DD&to=YYYY-MM-DD&channel=`
  - `GET /api/analytics/daily5?date=YYYY-MM-DD`
  - `POST /api/analytics/daily-note`（保存当日结论与行动项）

安全要点：GA4 Data API 的凭证（Service Account JSON / Token）仅保存在 Edge Function 环境变量中，前端不可见。

## 5.Server architecture diagram
```mermaid
graph TD
  A["前端（/analytics）"] --> B["Edge Function: analytics/*"]
  A --> C["Edge Function: public/*"]

  B --> D["Auth 校验"]
  B --> E["GA4 Data API 调用"]
  B --> F["Report Snapshot 读写"]

  C --> G["内容读取"]
  C --> H["Lead 写入"]

  subgraph "Supabase Edge Functions"
    B
    C
  end
  subgraph "Supabase Services"
    D
    F
    G
    H
  end
  subgraph "External"
    E
  end
```

## 6.Data model
### 6.1 Data model definition
```mermaid
erDiagram
  COURSES ||--o{ LIVE_SESSIONS : "has"
  COURSES ||--o{ LEADS : "receives"
  LIVE_SESSIONS ||--o{ LEADS : "receives"

  COURSES {
    uuid id
    string title
    string summary
    string highlights_json
    string audience_json
    string status
    datetime created_at
    datetime updated_at
  }
  LIVE_SESSIONS {
    uuid id
    uuid course_id
    string title
    datetime start_at
    datetime end_at
    string status
    datetime created_at
  }
  AI_ARTICLES {
    uuid id
    string type
    string title
    string summary
    string content
    string external_url
    string external_guide
    string tags_json
    datetime published_at
    datetime created_at
  }
  LEADS {
    uuid id
    string source_page
    uuid course_id
    uuid live_session_id
    string name
    string phone_or_wechat
    string intent
    datetime created_at
  }
  DAILY5_REPORT_SNAPSHOTS {
    uuid id
    date report_date
    string traffic_overview_json
    string funnel_json
    string live_performance_json
    string ai_content_performance_json
    string lead_result_json
    datetime created_at
  }
  DAILY_OPS_NOTES {
    uuid id
    date note_date
    string conclusion
    string action_items_json
    datetime created_at
  }
```

### 6.2 Data Definition Language
```sql
-- courses
CREATE TABLE courses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  summary TEXT NOT NULL,
  highlights_json JSONB NOT NULL DEFAULT '[]',
  audience_json JSONB NOT NULL DEFAULT '[]',
  status TEXT NOT NULL DEFAULT 'active',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- live_sessions
CREATE TABLE live_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  course_id UUID NOT NULL,
  title TEXT NOT NULL,
  start_at TIMESTAMPTZ NOT NULL,
  end_at TIMESTAMPTZ,
  status TEXT NOT NULL DEFAULT 'open',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_live_sessions_start_at ON live_sessions (start_at);

-- ai_articles
CREATE TABLE ai_articles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type TEXT NOT NULL CHECK (type IN ('original','external')),
  title TEXT NOT NULL,
  summary TEXT NOT NULL,
  content TEXT,
  external_url TEXT,
  external_guide TEXT,
  tags_json JSONB NOT NULL DEFAULT '[]',
  published_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_ai_articles_published_at ON ai_articles (published_at DESC);

-- leads
CREATE TABLE leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_page TEXT NOT NULL CHECK (source_page IN ('home','live','course')),
  course_id UUID,
  live_session_id UUID,
  name TEXT,
  phone_or_wechat TEXT NOT NULL,
  intent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_leads_created_at ON leads (created_at DESC);

-- daily 5 report snapshots
CREATE TABLE daily5_report_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  report_date DATE NOT NULL UNIQUE,
  traffic_overview_json JSONB NOT NULL DEFAULT '{}',
  funnel_json JSONB NOT NULL DEFAULT '{}',
  live_performance_json JSONB NOT NULL DEFAULT '{}',
  ai_content_performance_json JSONB NOT NULL DEFAULT '{}',
  lead_result_json JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- daily ops notes
CREATE TABLE daily_ops_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_date DATE NOT NULL UNIQUE,
  conclusion TEXT NOT NULL,
  action_items_json JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 权限（按 Supabase 常见策略：匿名仅读公开内容，登录用户全量；RLS 细则可后续补充）
GRANT SELECT ON courses, live_sessions, ai_articles TO anon;
GRANT ALL PRIVILEGES ON courses, live_sessions, ai_articles, leads, daily5_report_snapshots, daily_ops_notes TO authenticated;
```

补充：日常 5 报表可由 Scheduled Edge Function 每日生成写入 `daily5_report_snapshots`，看板读取历史快照，避免每次实时拉取 GA4。
